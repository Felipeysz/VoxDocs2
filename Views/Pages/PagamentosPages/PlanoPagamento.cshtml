@model VoxDocs.DTO.FinalizarPagamentoDto
@{
    Layout = null;
}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cadastro • VoxDocs</title>
    <meta name="description" content="Finalize seu cadastro e pagamento para acessar a plataforma VoxDocs" />

    <!-- Preload de recursos críticos -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" as="style" />
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" as="style" />

    <!-- Fonts e Ícones -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    
    <!-- CSS otimizado -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" 
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    
    <!-- CSS Inline para performance -->
    <style>
        :root {
            --clr-primary: #5c3c8a;
            --clr-primary-dark: #4a3070;
            --clr-primary-light: #774C9E;
            --clr-accent: #9c7fbc;
            --clr-bg: #fafafa;
            --clr-card: #ffffff;
            --clr-text: #333333;
            --clr-text-light: #666666;
            --clr-border: #e0e0e0;
        }

        body {
            background-color: var(--clr-bg);
            font-family: 'Poppins', system-ui, -apple-system, sans-serif;
            color: var(--clr-text);
            line-height: 1.5;
        }

        .doc-card {
            background: var(--clr-card);
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.05);
            padding: 2rem;
            max-width: 480px;
            width: 100%;
        }

        .btn-primary {
            background-color: var(--clr-primary);
            border-color: var(--clr-primary);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .btn-primary:hover, .btn-primary:focus {
            background-color: var(--clr-primary-dark);
            border-color: var(--clr-primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--clr-primary-light);
            box-shadow: 0 0 0 0.25rem rgba(92, 60, 138, 0.25);
        }

        /* Stepper */
        .stepper-line {
            position: absolute;
            top: 50%;
            left: 1rem;
            right: 1rem;
            height: 2px;
            background: var(--clr-primary-light);
            transform: translateY(-50%);
            z-index: 0;
        }

        .step {
            width: 36px;
            height: 36px;
            border: 2px solid var(--clr-primary-light) !important;
            background-color: white !important;
            color: var(--clr-primary) !important;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .step.active {
            background-color: var(--clr-primary) !important;
            color: white !important;
            border-color: var(--clr-primary) !important;
        }

        /* Otimizações específicas para .NET 9 */
        .step-content {
            will-change: opacity;
        }

        /* Animação simplificada */
        @@keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        /* Melhorias de acessibilidade */
        [aria-busy="true"] {
            cursor: progress;
        }

        /* Layout moderno */
        @@media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body class="d-flex align-items-center justify-content-center min-vh-100 p-2 p-md-5">
<div class="doc-card shadow-lg p-3 p-md-4 w-100">
    <!-- Header -->
    <header class="d-flex align-items-center gap-2 mb-3 text-primary fw-semibold fs-5">
        <span class="material-symbols-outlined fs-3" style="color: var(--clr-primary);">how_to_reg</span>
        <h1>Cadastro de Empresa</h1>
    </header>

    <!-- Plano Info -->
    <div class="alert alert-info mb-3" role="status">
        <p class="mb-0">Plano: <strong>@Model.NomePlano</strong> | Limite de usuários: <strong>@ViewBag.LimiteUsuarios</strong></p>
    </div>

    <!-- Stepper -->
    <div class="position-relative mb-4" aria-label="Progresso do cadastro">
        <div class="stepper-line"></div>
        <div class="d-flex justify-content-between position-relative">
            @for (int i = 1; i <= 5; i++)
            {
                <div class="step rounded-circle d-flex align-items-center justify-content-center @(i == 1 ? "active" : "bg-light text-muted")" 
                     style="width: 32px; height: 32px; z-index: 1;" aria-current="@(i == 1 ? "step" : null)">
                    @i
                </div>
            }
        </div>
    </div>

    <!-- Form -->
    <form id="formWizard" action="/api/Pagamentos/finalizar" method="POST" novalidate>
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Id" />
        <input type="hidden" asp-for="NomePlano"/>
        <input type="hidden" id="idPlano" value="@ViewBag.IdGerado" />
        <input type="hidden" id="nomePlano" value="@ViewBag.NomePlano" />
        <input type="hidden" id="periodicidadePlano" value="@ViewBag.Periodicidade" />

        <div id="stepContentContainer">

            <!-- STEP 1: Dados da Empresa -->
            <div class="step-content fade-in d-block" data-step="1" role="tabpanel" aria-labelledby="step-1">
                <div class="mb-3">
                    <label for="EmpresaContratante_EmpresaContratante" class="form-label">Nome da Empresa</label>
                    <input type="text" id="EmpresaContratante_EmpresaContratante" name="EmpresaContratante.EmpresaContratante" 
                           class="form-control" placeholder="Nome Empresa" required aria-required="true"/>
                </div>
                <div class="mb-3">
                    <label for="EmpresaContratante_Email" class="form-label">E-mail da Empresa</label>
                    <input type="email" autocomplete="email" id="EmpresaContratante_Email" name="EmpresaContratante.Email" 
                           class="form-control" placeholder="email@empresa.com" required aria-required="true"/>
                    <div id="emailError" class="text-danger mt-2 d-none" role="alert"></div>
                    <div id="emailSuccess" class="text-success mt-2 d-none" role="alert"></div>
                </div>
            </div>

            <!-- STEP 2: Pastas -->
            <div class="step-content fade-in d-none" data-step="2" role="tabpanel" aria-labelledby="step-2">
                <div class="mb-4">
                    <h2 class="fw-semibold h5">
                        <i class="fas fa-folder-tree me-2" aria-hidden="true"></i>
                        Gerenciamento de Pastas
                    </h2>
                    <div id="pastasPrincipaisContainer" class="mb-4"></div>
                    <button type="button" id="btnAdicionarPastaPrincipal" class="btn btn-outline-primary mb-4">
                        <i class="fas fa-plus-circle me-2" aria-hidden="true"></i>Adicionar Pasta Principal
                    </button>
                </div>
                <div id="step2Error" class="text-danger mt-2 d-none" role="alert"></div>
                <div id="step2Success" class="text-success mt-2 d-none" role="alert"></div>
                
                <template id="templatePastaPrincipal">
                    <div class="pasta-principal card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-folder me-2" aria-hidden="true"></i>
                                <input type="text" class="pasta-nome form-control form-control-sm" 
                                       placeholder="Nome da Pasta Principal" required aria-required="true">
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger btn-remover-pasta" aria-label="Remover pasta">
                                <i class="fas fa-trash" aria-hidden="true"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <h3 class="h6 mb-2">Subpastas</h3>
                            <div class="subpastas-container mb-3"></div>
                            <button type="button" class="btn btn-sm btn-outline-secondary btn-adicionar-subpasta">
                                <i class="fas fa-plus me-1" aria-hidden="true"></i>Adicionar Subpasta
                            </button>
                        </div>
                    </div>
                </template>
                
                <template id="templateSubpasta">
                    <div class="subpasta-item input-group mb-2">
                        <input type="text" class="subpasta-nome form-control form-control-sm" 
                               placeholder="Nome da Subpasta" required aria-required="true">
                        <button type="button" class="btn btn-sm btn-outline-danger btn-remover-subpasta" aria-label="Remover subpasta">
                            <i class="fas fa-times" aria-hidden="true"></i>
                        </button>
                    </div>
                </template>
            </div>
            
            <!-- STEP 3: Administradores -->
            <div class="step-content fade-in d-none" data-step="3" role="tabpanel" aria-labelledby="step-3">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h2 class="h5 mb-0">
                            <i class="fas fa-user-shield me-2" aria-hidden="true"></i>
                            Administradores
                        </h2>
                        <span class="badge" style="background-color: var(--clr-primary-light);">
                            <span id="adminCount">0</span> / <span id="adminLimit">@ViewBag.LimiteAdmin</span>
                        </span>
                    </div>
                    <div id="adminsContainer" class="mb-3"></div>
                    @if (ViewBag.LimiteAdmin > 1)
                    {
                        <button type="button" class="btn btn-primary mb-3" id="btnAdicionarAdmin">
                            <i class="material-symbols-outlined align-middle" aria-hidden="true">add</i>
                            Adicionar Administrador
                        </button>
                    }
                </div>
                <div class="alert alert-info mb-3" role="status">
                    <strong>Limites do Plano:</strong>
                    <div>Administradores permitidos: <strong>@ViewBag.LimiteAdmin</strong></div>
                </div>
                <div id="step3Error" class="text-danger mt-2 d-none" role="alert"></div>
                <div id="step3Success" class="text-success mt-2 d-none" role="alert"></div>
                
                <template id="templateAdmin">
                    <div class="admin-card mb-3 p-3 border rounded">
                        <h3 class="h6 mb-2">
                            Administrador <span class="admin-index"></span>
                        </h3>
                        <div class="mb-2">
                            <label class="form-label">Usuário (login)</label>
                            <input data-field="Usuario" type="text" class="form-control" 
                                   placeholder="Login do Admin" required aria-required="true">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">E-mail do Administrador</label>
                            <input data-field="Email" type="email" autocomplete="email" 
                                   class="form-control" placeholder="email@empresa.com" required aria-required="true">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Senha</label>
                            <div class="input-group">
                                <input data-field="Senha" type="password" autocomplete="new-password" 
                                       class="form-control password-field" placeholder="Senha do Admin" required aria-required="true">
                                <button class="toggle-password btn btn-outline-secondary" type="button" aria-label="Mostrar senha">
                                    <i class="fas fa-eye" aria-hidden="true"></i>
                                </button>
                            </div>
                        </div>
                        <input data-field="PermissionAccount" type="hidden" value="Admin">
                        <button type="button" class="btn btn-outline-danger btn-sm remover-admin">
                            <i class="material-symbols-outlined align-middle" aria-hidden="true">delete</i>
                            Remover
                        </button>
                    </div>
                </template>
            </div>

            <!-- STEP 4: Usuários Comuns -->
            <div class="step-content fade-in d-none" data-step="4" role="tabpanel" aria-labelledby="step-4">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h2 class="h5 mb-0">
                            <i class="fas fa-users me-2" aria-hidden="true"></i>
                            Usuários Comuns
                        </h2>
                        <span class="badge" style="background-color: var(--clr-primary-light);">
                            <span id="userCount">0</span> / <span id="userLimit">@ViewBag.LimiteUsuarios</span>
                        </span>
                    </div>
                    <div id="usersContainer" class="mb-4"></div>
                    @if (ViewBag.LimiteUsuarios > 1)
                    {
                        <button type="button" class="btn btn-primary mb-4" id="btnAdicionarUser">
                            <i class="material-symbols-outlined align-middle" aria-hidden="true">add</i>
                            Adicionar Usuário
                        </button>
                    }
                </div>
                <div class="alert alert-info mb-3" role="status">
                    <strong>Limites do Plano:</strong>
                    <div>Total de usuários permitidos: <strong>@ViewBag.LimiteUsuarios</strong></div>
                    <div>Usuários comuns disponíveis: <strong>@ViewBag.Disponiveis</strong></div>
                </div>
                <div id="step4Error" class="text-danger mt-2 d-none" role="alert"></div>
                <div id="step4Success" class="text-success mt-2 d-none" role="alert"></div>
                
                <template id="templateUser">
                    <div class="user-card mb-3 p-3 border rounded">
                        <h3 class="h6 mb-2">Usuário <span class="user-index"></span></h3>
                        <div class="mb-2">
                            <label class="form-label">Usuário (login)</label>
                            <input data-field="Usuario" type="text" class="form-control" 
                                   placeholder="Login do Usuário" required aria-required="true">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">E-mail do Usuário</label>
                            <input data-field="Email" type="email" autocomplete="email" 
                                   class="form-control" placeholder="email@empresa.com" required aria-required="true">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Senha</label>
                            <div class="input-group">
                                <input data-field="Senha" type="password" autocomplete="new-password" 
                                       class="form-control password-field" placeholder="Senha do Usuário" required aria-required="true">
                                <button type="button" class="toggle-password btn btn-outline-secondary" aria-label="Mostrar senha">
                                    <i class="fas fa-eye" aria-hidden="true"></i>
                                </button>
                            </div>
                        </div>
                        <input data-field="PermissionAccount" type="hidden" value="User">
                        <button type="button" class="btn btn-outline-danger btn-sm remover-user">
                            <i class="material-symbols-outlined align-middle" aria-hidden="true">delete</i>
                            Remover
                        </button>
                    </div>
                </template>
            </div>

            <!-- STEP 5: Pagamento -->
            <div class="step-content fade-in d-none" data-step="5" role="tabpanel" aria-labelledby="step-5">
                <div class="text-center mb-4">
                    <h2 class="fw-bold text-primary mb-3">
                        <i class="fas fa-credit-card me-2" aria-hidden="true"></i>Pagamento
                    </h2>
                    <p class="text-muted">Finalize seu cadastro com segurança</p>
                </div>

                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body p-4">
                        <!-- Cartão de Crédito -->
                        <div id="card">
                            <div class="inputs">
                                <!-- Número do cartão -->
                                <div class="input-group mb-3">
                                    <span class="input-group-text bg-transparent border-end-0">
                                        <i class="fas fa-credit-card text-primary" aria-hidden="true"></i>
                                    </span>
                                    <input type="text" id="cartaoNumber" maxlength="19" required placeholder="Número do cartão"
                                           autocomplete="cc-number" class="form-control border-start-0 ps-0" 
                                           aria-label="Número do cartão de crédito" />
                                </div>

                                <div class="row g-3">
                                    <!-- Validade -->
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-text bg-transparent border-end-0">
                                                <i class="far fa-calendar-alt text-primary" aria-hidden="true"></i>
                                            </span>
                                            <input type="text" id="validadeCartao" maxlength="5" required placeholder="MM/AA"
                                                   autocomplete="cc-exp" class="form-control border-start-0 ps-0" 
                                                   aria-label="Data de validade do cartão" />
                                        </div>
                                    </div>

                                    <!-- CVV -->
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-text bg-transparent border-end-0">
                                                <i class="fas fa-lock text-primary" aria-hidden="true"></i>
                                            </span>
                                            <input type="text" id="cvvCartao" maxlength="4" required placeholder="CVV"
                                                   autocomplete="cc-csc" class="form-control border-start-0 ps-0" 
                                                   aria-label="Código de segurança do cartão" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <button type="button" class="btn btn-primary btn-lg px-5 py-3 fw-bold" id="pagarCartao" aria-busy="false">
                        <i class="fas fa-lock me-2" aria-hidden="true"></i>Finalizar Pagamento
                    </button>
                    <div id="resCartao" class="alert d-none mt-4 p-3 rounded" role="alert"></div>
                </div>
            </div>
        </div>

        <!-- Navegação -->
        <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-outline-secondary" id="prevBtn" disabled aria-label="Voltar passo anterior">« Anterior</button>
            <button type="button" class="btn btn-primary" id="nextBtn" aria-label="Avançar para próximo passo">Próximo »</button>
        </div>
    </form>
</div>

<!-- Scripts otimizados -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" 
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" 
        crossorigin="anonymous" defer></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js" 
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" 
        crossorigin="anonymous" defer></script>

<!-- Script modular com type="module" -->
<script type="module" src="~/js/PagamentoScript/main.js" defer></script>

<!-- Inline script para inicialização -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Verificar token na URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        
        if (token) {
            const form = document.getElementById('formWizard');
            const tokenInput = document.createElement('input');
            tokenInput.type = 'hidden';
            tokenInput.name = 'token';
            tokenInput.value = token;
            form.appendChild(tokenInput);
            form.submit();
        }
        
        // Otimização: Pré-conectar a origens externas
        const preconnectLinks = [
            'https://fonts.googleapis.com',
            'https://fonts.gstatic.com',
            'https://cdn.jsdelivr.net'
        ];
        
        preconnectLinks.forEach(link => {
            const preconnect = document.createElement('link');
            preconnect.rel = 'preconnect';
            preconnect.href = link;
            preconnect.crossOrigin = '';
            document.head.appendChild(preconnect);
        });
    });
</script>
</body>
</html>